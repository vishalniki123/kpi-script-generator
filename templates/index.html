<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KPI Script Generator</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
</head>

<body>

<div class="app-container">

  <!-- HEADER -->
  <header class="app-header">
    <h3>DCT KPI Script Generator</h3>
    <p class="header-subtitle">
      Generate PSQ and SQD KPI Excel scripts from master KPI definitions
    </p>
  </header>

  <!-- FORM -->
  <main class="form-container">
    <form id="kpiForm" enctype="multipart/form-data">

      <!-- KPI MASTER -->
      <div class="form-section">
        <h5>1. KPI Master Excel</h5>
        <p class="help-text">
          Upload the KPI master file.<br>
          • Sheet 1 → PSQ KPIs<br>
          • Sheet 2 → SQD KPIs
        </p>
        <input type="file" class="form-control" name="kpi_excel" required>
      </div>

      <!-- PSQ -->
      <div class="form-section">
        <h5>2. PSQ Script Templates</h5>

        <label class="form-label">
          PSQ – Normal KPI Template
        </label>
        <p class="help-text">
          Used for KPIs where Target ≠ "Tracking Only"
        </p>
        <input type="file" class="form-control mb-3" name="psq1" required>

        <label class="form-label">
          PSQ – Tracking Only Template
        </label>
        <p class="help-text">
          Used when KPI Target = "Tracking Only"
        </p>
        <input type="file" class="form-control" name="psq2" required>
      </div>

      <!-- SQD -->
      <div class="form-section">
        <h5>3. SQD Script Templates</h5>

        <label class="form-label">
          SQD – Normal KPI Template
        </label>
        <input type="file" class="form-control mb-3" name="sqd1" required>

        <label class="form-label">
          SQD – Tracking Only Template
        </label>
        <input type="file" class="form-control" name="sqd2" required>
      </div>

      <!-- SUBMIT -->
      <button type="submit" class="btn btn-primary btn-lg w-100">
        Generate KPI Scripts
      </button>

    </form>
  </main>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner-border mb-3"></div>
    <div>Generating KPI scripts…</div>
    <small>Please wait</small>
  </div>
</div>

<!-- SUCCESS MODAL -->
<div class="modal fade" id="successModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-4">
      <h5>Generation Completed</h5>
      <hr>

      <div class="row">
        <div class="col">
          <h6>PSQ Files</h6>
          <ul id="psqFiles"></ul>
        </div>
        <div class="col">
          <h6>SQD Files</h6>
          <ul id="sqdFiles"></ul>
        </div>
      </div>

      <a href="/download" class="btn btn-success w-100 mt-4">
        Download All Files (ZIP)
      </a>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.getElementById("kpiForm").onsubmit = async function (e) {
      e.preventDefault();
      document.getElementById("loadingOverlay").style.display = "flex";

      const response = await fetch("/", {
          method: "POST",
          body: new FormData(this)
      });

      document.getElementById("loadingOverlay").style.display = "none";

      const data = await response.json();

      document.getElementById("psqFiles").innerHTML =
          data.files.psq.map(f => `<li>${f}</li>`).join("");

      document.getElementById("sqdFiles").innerHTML =
          data.files.sqd.map(f => `<li>${f}</li>`).join("");

      new bootstrap.Modal(document.getElementById("successModal")).show();
  };
</script>

</body>
</html>
